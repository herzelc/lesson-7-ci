name: Full DevOps Pipeline - Final Version

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  devops-pipeline:
    runs-on: ubuntu-latest
    steps:
      # 1. משיכת הקוד מה-Repository לשרת ה-Ubuntu הזמני
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. בדיקת תקינות קובץ ה-JSON
      - name: Validate Config JSON
        run: |
          echo "Validating JSON file..."
          jq . app-config.json

      # 3. התקנת Helm ובדיקת ה-Chart (עם תיקון ה-Token שדיברנו עליו)
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Helm Lint
        run: |
          echo "Running Helm lint on my-chart..."
          helm lint ./my-chart

      # 4. בניית ה-Docker Image, הרצה ובדיקה שהכל עובד "חי"
      - name: Build and Test Docker Image
        run: |
          echo "Building Docker Image..."
          docker build -t my-first-app .
          
          echo "Starting Container for testing..."
          docker run -d -p 8080:80 --name test-container my-first-app
          
          # המתנה של 5 שניות כדי לתת ל-Nginx זמן לעלות
          sleep 5
          
          echo "Performing Smoke Test (Health Check)..."
          # הפקודה תכשל אם השרת לא יחזיר תשובה תקינה (200 OK)
          curl --fail http://localhost:8080/config.json
          
          echo "Test passed! Cleaning up..."
          docker stop test-container
          docker rm test-container

      - name: Final Summary
        run: echo "CI Pipeline completed successfully for all stages!"